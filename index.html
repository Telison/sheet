<html>
  <head>
    <title>Lost Ark European Servers</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <link rel="icon" type="image/png" href="favicon.png" />
    <link
      href="http://fonts.googleapis.com/css?family=Lato:400,700"
      rel="stylesheet"
      type="text/css"
    />
    <style>
      html,
      body {
        font-family: Lato, Sans-Serif;
        color: #ddd;
        background: #202020;
        padding: 20px;
        margin: 0;
      }

      h1 {
        margin-top: 0;
        margin-bottom: 30px;
      }

      #content {
        display: flex;
        flex-flow: row wrap;
      }

      .server-container {
        margin: 0 20px 20px 0;
        border-radius: 6px;
        padding: 12px;
        background: #303030;
      }

      .server-name {
        font-size: 20px;
        font-weight: bold;
        margin-bottom: 14px;
        color: white;
      }

      .language-container {
        display: flex;
        justify-content: space-between;
        margin-bottom: 3px;
      }

      .language-name {
        margin-right: 20px;
      }

      #error {
        color: #dd7070;
      }
    </style>
    <script>
      const documentId = "1wJiDGy77tOdV7ATqXj-bGXH7JmQo-sbjHrYJTcoI4Ow";
      const pageId = "1303305384";
      const callbackname = "callback";
      const tq = "select E, F, G";
      const url = `https://docs.google.com/spreadsheets/d/${documentId}/gviz/tq?tqx=out:json;responseHandler:${callbackname}&tq=${tq}&gid=${pageId}`;
      const encodedUrl = encodeURIComponent(url);
      const apiUrl = `https://api.allorigins.win/get?url=${encodedUrl}`;

      fetch(apiUrl)
        .then((response) => response.text())
        .then((responseText) => convertToJson(responseText))
        .then((json) => parse(json))
        .then((servers) => generateHtml(servers))
        .then((html) => (document.querySelector("#content").innerHTML = html))
        .catch((error) => displayError(error));

      function callback(data) {
        return data;
      }

      function convertToJson(data) {
        const outerJson = JSON.parse(data);
        const contents = outerJson.contents;
        const index = contents.indexOf(callbackname);
        const functionCall = contents.slice(index);
        return eval(functionCall);
      }

      function isEuServer(serverName) {
        const euServers = [
          "Neria",
          "Kadan",
          "Trixion",
          "Calvasus",
          "Thirain",
          "Zinnervale",
          "Asta",
          "Wei",
          "Slen",
        ];
        return euServers.includes(serverName);
      }

      function normalizeName(name) {
        if (name) {
          name = name.trim();
          name = name.charAt(0).toUpperCase() + name.slice(1);
        }
        return name;
      }

      function parse(json) {
        const servers = [];

        for (const row of json.table.rows) {
          const serverName = normalizeName(row.c[1].v);

          if (!isEuServer(serverName)) {
            continue;
          }

          const sizeName = row.c[0].v;
          const size = sizeName == "Small" ? 1 : sizeName == "Medium" ? 2 : 3;
          const languageName = normalizeName(row.c[2].v);

          let server = servers.find((s) => s.name == serverName);

          if (!server) {
            server = { name: serverName, languages: [] };
            servers.push(server);
          }

          let language = server.languages.find((l) => l.name == languageName);

          if (!language) {
            language = { name: languageName, count: 0 };
            server.languages.push(language);
          }

          language.count += size;
        }

        for (const server of servers) {
          server.languages = server.languages.sort((a, b) => b.count - a.count);
        }

        return servers;
      }

      function generateHtml(servers) {
        var html = "";
        for (const server of servers) {
          html = html + generateServerHtml(server);
        }
        return html;
      }

      function generateServerHtml(server) {
        let html = '<div class="server-container">';
        html += `<div class="server-name">${server.name}</div>`;
        html += '<div class="languages-container">';

        for (const language of server.languages) {
          html += '<div class="language-container">';
          html += `<div class="language-name">${language.name}</div>`;
          html += `<div class="language-count">${language.count}</div>`;
          html += "</div>";
        }

        html += "</div></div>";

        return html;
      }

      function displayError(error) {
        document.querySelector("#error").innerHTML = error;
      }
    </script>
  </head>

  <body>
    <h1>Lost Ark European Servers</h1>
    <div id="content"></div>
    <div id="error"></div>
  </body>
</html>
